<!DOCTYPE html>
<html lang="vi">
<head>
    <title>{{ san.ten_san }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .san-header { background: #00b14f; color: white; padding: 20px 0; }
        .map-box { height: 400px; border-radius: 12px; border: 2px solid #ddd; position: relative; z-index: 1;}
        .info-card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
        .btn-gps { position: absolute; bottom: 20px; right: 20px; z-index: 999; background: white; border: 2px solid #00b14f; color: #00b14f; font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <div class="san-header mb-4">
        <div class="container">
            <a href="{% url 'home' %}" class="text-white text-decoration-none"><i class="fas fa-arrow-left"></i> Quay lại</a>
            <h2 class="fw-bold mt-2">{{ san.ten_san }}</h2>
            <p class="mb-0"><i class="fas fa-map-marker-alt"></i> {{ san.dia_chi }}</p>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card info-card mb-3">
                    {% if san.hinh_anh %}
                        <img src="{{ san.hinh_anh.url }}" class="card-img-top" style="height: 250px; object-fit: cover;">
                    {% else %}
                        <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 250px;"><i class="fas fa-image fa-3x"></i></div>
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="text-success fw-bold m-0">{{ san.gia_tien }}đ<small class="text-muted fs-6">/giờ</small></h4>
                            <div class="text-warning"><i class="fas fa-star"></i> {{ san.danh_gia }}</div>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="{% url 'dat_san' san.pk %}" class="btn btn-warning fw-bold text-white btn-lg shadow-sm">ĐẶT LỊCH NGAY</a>
                        </div>
                    </div>
                </div>

                <div class="card info-card p-3">
                    <h5 class="fw-bold text-secondary"><i class="fas fa-route"></i> Tính Quãng Đường</h5>
                    <p class="small text-muted mb-2">Click vào bản đồ hoặc bấm nút định vị.</p>
                    <div class="alert alert-info d-flex justify-content-between p-2">
                        <span>Khoảng cách:</span><strong class="fs-5 text-primary" id="distance-result">--- km</strong>
                    </div>
                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ san.vi_do }},{{ san.kinh_do }}" 
                       target="_blank" class="btn btn-outline-primary w-100"><i class="fas fa-directions"></i> Chỉ đường Google Maps</a>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="map-box shadow" id="detail-map">
                    <button class="btn btn-gps px-3 py-2 rounded-pill shadow" onclick="getLocation()"><i class="fas fa-crosshairs"></i> Vị trí của tôi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var sanLat = {{ san.vi_do }};
        var sanLng = {{ san.kinh_do }};
        var map = L.map('detail-map').setView([sanLat, sanLng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        L.marker([sanLat, sanLng], {icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        })}).addTo(map).bindPopup("<b>{{ san.ten_san }}</b>").openPopup();

        var userMarker = null;
        var routeLine = null;

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return (R * c).toFixed(2);
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        function updateUserLocation(lat, lng) {
            if (userMarker) map.removeLayer(userMarker);
            if (routeLine) map.removeLayer(routeLine);
            userMarker = L.marker([lat, lng]).addTo(map).bindPopup("Bạn ở đây").openPopup();
            var latlngs = [[sanLat, sanLng], [lat, lng]];
            routeLine = L.polyline(latlngs, {color: 'blue', dashArray: '10, 10'}).addTo(map);
            map.fitBounds(latlngs, {padding: [50, 50]});
            document.getElementById('distance-result').innerHTML = getDistanceFromLatLonInKm(sanLat, sanLng, lat, lng) + " km";
        }

        map.on('click', function(e) { updateUserLocation(e.latlng.lat, e.latlng.lng); });
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(p) { updateUserLocation(p.coords.latitude, p.coords.longitude); });
            } else { alert("Không hỗ trợ GPS"); }
        }
    </script>
</body>
</html>